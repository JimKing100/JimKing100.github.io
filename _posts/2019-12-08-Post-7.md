---
layout: post
title: How to Create an Interactive Dash Web Application
subtitle: Using Dash, Heroku, XGBoost and Pickling to Create a Predictive Web App
image: '/img/Marin.jpg'
comments: true
published: false
---

You've done the data science, now you need to present the results to the world!  [Dash][1] is a python framework for building web applications.  Written on top of Flask, Plotly.js and React.js, Dash is well-suited for quickly building customized web applications.  Once built, the web application can easily be deployed on a cloud platform such as [Heroku][2].

Let's start with the final product.  The simple web app below (or at this link [Multiple Offer Calculator][3]) enables the user to determine the predicted price to pay for a home facing a bidding a war. The predicted price is based on historical data from 2015 - 2019 for all single-family homes sold in Marin County, CA receiving two or more offers. The user can select the area, number of bedrooms, number of baths, number of expected offers and listing price and the app will provide the predicted sales price.

To use the web app simply select the Predict tab, select the criteria and the app will return the predicted offer price.  For an explanation of the goals, data, evaluation protocol and model selection use the Explain tab.  The Evaluation tab provides metrics used to evaluate the accuracy of the predictions versus the actual winning offers.

<iframe src="https://multiple-offers.herokuapp.com" width="900" height="900" style="border: none;"></iframe>

If youâ€™d like to understand how to develop your own interactive web app follow along as I step you through the process.

### A Word About the Code

All the code, data and associated files for the project can be accessed at my [GitHub][4].

### The Data Science

As this article is focused on the creation of an interactive web app, I will briefly describe the data science used to predict the optimal bid price.  For details take a look at the colab notebook [here][5].

The raw data is historical data from 2015 - 2019 for all single-family homes sold in Marin County, CA receiving two or more offers.  After importing the raw data and mapping the areas to their city names, the data looks like this:

![MultiOffer Dataframe](/img/MultiOffer_Dataframe.png)

The data was divided into training (2015 - 2017) with 2,973 sales, validation (2018) with 991 sales and test (2019) with 776 sales. The test set contains about 11 months of data from 2019.

```
# Split into train and test - 2015-2018 in train, 2019 in test
low_cutoff = 2015
high_cutoff = 2019
train = df[(df['Year'] >= low_cutoff) & (df['Year'] < high_cutoff)]
test  = df[df['Year'] >= high_cutoff]

# Split train into train and validation - 2015-2017 in train and 2018 in validation
cutoff = 2018
temp=train.copy()
train = temp[temp['Year'] < cutoff]
val  = temp[temp['Year'] >= cutoff]
```

A simple linear regression was initially run with excellent results. An XGBoost model was then run and had slightly better metrics and was therefore selected as the model.

|           | Validation |   Test  |
|-----------|------------|---------|
| MAE       | $71,851    | $68,002 |
| R-Squared | 0.9726     | 0.9839  |

### Pickling

Pickling is used for serializing and de-serializing Python objects (also referred to as marshalling or flattening).  Pickling is very useful when working with machine learning algorithms when you want to save the process in order to make predictions at a later time without having to re-train your model.  In our case, we are going to pickle the pipeline and use it in our web app for making predictions.  

First we import dump from joblib:

```
from joblib import dump
```

Next we run the XGBoost model and dump the pipeline.  This essentially saves the pipeline to a file named pipeline.joblib on our local disk.  This file is then loaded into GitHub and used in the predict.py code in the web app.

```
# Encode and fit a XGBoost model
target = 'Selling Price'

features = train.columns.drop(target)
X_train = train[features]
y_train = train[target]
X_val = val[features]
y_val = val[target]
X_test = test[features]
y_test = test[target]

pipeline = make_pipeline(
    ce.OneHotEncoder(use_cat_names=True), 
    XGBRegressor(n_estimators=200, n_jobs=-1)
)

pipeline.fit(X_train, y_train)
dump(pipeline, 'pipeline.joblib')
y_pred = pipeline.predict(X_val)
```

### The Dash App

Dash apps are composed of a "layout" defining the look of the app and "callbacks" creating the interactivity.  Our basic Dash app is composed of the app.py and the index.py files.

#### app.py

```
import dash

external_stylesheets = ['https://codepen.io/chriddyp/pen/bWLwgP.css']

app = dash.Dash(__name__, external_stylesheets=external_stylesheets)
app.config.suppress_callback_exceptions = True
server = app.server
```

#### index.py

```
from dash.dependencies import Input, Output
import dash_core_components as dcc
import dash_html_components as html

from app import app, server
from tabs import intro, predict, explain, evaluate

style = {'maxWidth': '960px', 'margin': 'auto'}

app.layout = html.Div([
    dcc.Markdown('# Multiple Offer Calculator'),
    dcc.Tabs(id='tabs', value='tab-intro', children=[
        dcc.Tab(label='Intro', value='tab-intro'),
        dcc.Tab(label='Predict', value='tab-predict'),
        dcc.Tab(label='Explain', value='tab-explain'),
        dcc.Tab(label='Evaluate', value='tab-evaluate'),
    ]),
    html.Div(id='tabs-content'),
], style=style)

@app.callback(Output('tabs-content', 'children'),
              [Input('tabs', 'value')])
def render_content(tab):
    if tab == 'tab-intro': return intro.layout
    elif tab == 'tab-predict': return predict.layout
    elif tab == 'tab-explain': return explain.layout
    elif tab == 'tab-evaluate': return evaluate.layout

if __name__ == '__main__':
    app.run_server(debug=True)
```

### Heroku Deployment




*Marin Real Estate Data Source:  Marin MLS (BAREIS), 2015-2019 Data*

[1]: <https://dash.plot.ly/introduction>
[2]: <https://www.heroku.com/what>
[3]: <https://multiple-offers.herokuapp.com> 
[4]: <https://github.com/JimKing100/Multiple_Offers>
[5]: <https://github.com/JimKing100/Multiple_Offers/blob/master/model/XGBoost.ipynb>

